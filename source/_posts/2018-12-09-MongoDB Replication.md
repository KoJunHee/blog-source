---
layout: post
title:  "MongoDB Replication"
date:   2018-12-09
categories: Node.js
---

##### 복제 (replication) 가 무엇인가요?

여러 서버 상에서 데이터의 동일한 복사본을 유지하는 방법입니다.

##### 복제의 장점은 무엇인가요?

한 대 또는 그 이상의 서버에 이상이 발생하였을 때, 애플리케이션의 정상 동작 및 데이터를 안전하게 보존할 수 있습니다.

1. 백업
2. 역할 분리

##### MongoDB는 복제를 어떻게 하나요?

복제 셋 (replica set) 을 생성함으로써 복제를 할 수 있습니다.

##### master-slave 복제는 없나요?

MongoDB 4.0 에서 master-slave replication 에 대한 지원을 제거했습니다.

##### replica set은 어떻게 구성되나요?

1대의 primary 서버와 여러 대의 secondary 서버로 구성합니다.

##### primary server의 특징은?

클라이언트의 요청을 처리합니다. 데이터에 대한 read, write 모두 가능합니다.

##### secondary server의 특징은?

프라이머리 데이터의 복제 데이터를 가집니다. 프라이머리의 oplog 에서 하던 동작을 세컨더리의 데이터 셋에 비동기적으로 적용합니다. 프라이머리 서버에 장애가 발생시 세컨더리 서버는 자신들 중 새로운 프라이머리 서버를 선출할 수 있습니다. 데이터의 읽기만 가능합니다.

##### 데이터 복제는 어떻게 진행되나요?

세컨더리는 롱 폴링(long polling) 방식을 사용하여 프라이머리의 변경 데이터를 즉각적으로 적용합니다.

1. 클라이언트가 프라이머리 노드에 대해 쓰기를 할 때마다, 세컨더리에서 재생하기 위한 충분한 정보가 프라이머리 노드의 oplog에 자동으로 추가됩니다.
2. 세컨더리 노드는 자신의 오프로그에서 가장 최근 항목의 timestamp를 검사합니다.
3. 세컨더리 노드는 프라이머리 노드의 오피로그에서 최근 항목의 timestamp 이후의 모든 oplog 항목을 질의합니다.
4. 질의된 oplog 항목을 자신의 oplog에 추가합니다.
5. 추가된 oplog의 항목을 자신의 데이터에 적용합니다.

##### oplog가 무엇인가요?

캡드(capped) 컬렉션으로, 모든 복제 노드에서 local 이라는 데이터베이스 내에 존재합니다.

##### capped collection 이란?

고정된 크기(fixed size) 를 가진 컬렉션입니다. circular buffer와 비슷하게 동작합니다. 할당된 공간을 모두 채우면, 가장 오래된 document 를 덮어씁니다.

##### MongoDB가 건강상태를 확인하는 방법은 무엇인가요?

하트비트(heartbeat)를 합니다. 복제 셋의 각 멤버는 디폴트로 다른 멤버들을 매 2초마다 한 번씩 핑 (ping) 을 해봄으로써, 시스템의 건강 상태를 확인할 수 있습니다. 모든 모드가 건강한 상태일때만 복제 셋이 정상 동작하는 것이며 한 노드라도 반응이 없으면 조치를 취해야 합니다.

##### 장애가 발생했을 때 어떻게 하나요?

장애 발생시 새로운 프라이머리를 선출해야 합니다. 투표를 위해서는 과반수 이상이 필요합니다. 과반수란 복제 셋의 모든 멤버의 절반보다 많은 것입니다. 예를 들어, 

복제 셋의 멤버 수가 1 이면 복제 셋의 과반수는 1
복제 셋의 멤버 수가 2 이면 복제 셋의 과반수는 2
복제 셋의 멤버 수가 3 이면 복제 셋의 과반수는 2
복제 셋의 멤버 수가 4 이면 복제 셋의 과반수는 3
복제 셋의 멤버 수가 5 이면 복제 셋의 과반수는 3

##### Arbiter란?

데이터의 복제에는 참여하지 않지만 프라이머리 선출에만 참여하는 중재자입니다. 프라이머리 1대와 세컨더리 1대로 이뤄진 복제 셋의 과반수는 2인데 프라이머리의 장애시 투표를 행사할 수 있는 서버는 1대 뿐이므로 프라이머리를 선출할 수 없습니다. 그래서 arbiter가 필요합니다.

##### reference

http://kwsstudy.github.io/post/%EB%B3%B5%EC%A0%9C/